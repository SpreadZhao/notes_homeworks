---
title: "2.3 Mechanism: Limited Direct Execution"
order: "4"
---
[[Study Log/os_study/0_ostep_index|Return to Index]]

## 2.3 Mechanism: Limited Direct Execution

æƒ³è™šæ‹ŸåŒ–CPUï¼Œåº•å±‚åŸç†å…¶å®å¾ˆç®€å•ï¼šè¿è¡Œä¸€å°ä¼šå„¿è¿™ä¸ªç¨‹åºï¼Œç„¶åè¿è¡Œä¸€å°ä¼šå„¿é‚£ä¸ªâ€¦â€¦ä½†æ˜¯è¿™æ ·æ“ä½œä¼šå¸¦æ¥å¾ˆå¤šé—®é¢˜ã€‚æœ€é‡è¦çš„ä¸¤ä¸ªé—®é¢˜ï¼š

- performanceï¼šå®ç°è¿™æ ·çš„è™šæ‹ŸåŒ–å¿…é¡»ä¿è¯æ€§èƒ½ï¼Œå°½å¯èƒ½å°‘å¸¦æ¥é¢å¤–å¼€é”€ï¼›
- controlï¼šå¿…é¡»åœ¨OSçš„æ§åˆ¶ä¸‹ï¼Œæ¯”å¦‚ä¸€ä¸ªè¿›ç¨‹ä¸èƒ½éšä¾¿è·å–CPUèµ„æºã€‚

è¦å®ç°è¿™ä¸ªï¼Œç¡¬ä»¶å’Œè½¯ä»¶ï¼ˆOSï¼‰éƒ½æ˜¯éœ€è¦çš„ã€‚

### 2.3.1 Basic Technique: Limited Direct Execution

ä¸ºäº†å®ç°è¿™äº›ï¼ŒOSçš„å¼€å‘è€…æå‡ºäº†ä¸€ä¸ªæ¦‚å¿µå«Limited Direct Executionã€‚æˆ‘ä»¬å…ˆè§£é‡Šä»€ä¹ˆæ˜¯Direct Executionã€‚éå¸¸ç®€å•ï¼Œå°±æ˜¯ç›´æ¥è®©ç¨‹åºè¿è¡Œåœ¨CPUä¸Šã€‚å½“ç¨‹åºå¼€å§‹è¿è¡Œæ—¶ï¼ŒOSå°±éœ€è¦åšä¸‹é¢çš„äº‹æƒ…ï¼š

| OS                       | Program  |
| ------------------------ | -------- |
| åœ¨è¿›ç¨‹åˆ—è¡¨ä¸­åˆ›å»ºå½“å‰è¿›ç¨‹çš„é¡¹ç›®          |          |
| ç»™è¿›ç¨‹åˆ†é…å†…å­˜                  |          |
| æŠŠç¨‹åºä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­             |          |
| è®¾ç½®å¥½ç¨‹åºçš„æ ˆç©ºé—´ï¼ˆé€šè¿‡argc / argvï¼‰ |          |
| æ¸…é™¤å¯„å­˜å™¨                    |          |
| å¼€å§‹è°ƒç”¨ç¨‹åºçš„mainå‡½æ•°            |          |
|                          | mainå¼€å§‹è¿è¡Œ |
|                          | mainè¿”å›   |
| é‡Šæ”¾ç¨‹åºçš„å†…å­˜                  |          |
| æŠŠç¨‹åºä»è¿›ç¨‹åˆ—è¡¨ä¸­åˆ é™¤              |          |

^90c713

å¾ˆç®€å•ï¼Œä½†æ˜¯å¸¦æ¥ä¸¤ä¸ªé—®é¢˜ï¼š

1. å¤ªç®€å•äº†ï¼Œæ²¡åŠæ³•ä¿è¯ç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™ä¸ä¼šå¹²ä»€ä¹ˆåäº‹â€”â€”2.3.2ï¼›
2. è¿è¡Œä¸€ä¸ªè¿›ç¨‹çš„æ—¶å€™ï¼Œæ€ä¹ˆåœä¸‹æ¥è¿è¡Œå¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä»è€Œå®ç°time-sharingâ€”â€”2.3.3ã€‚

### 2.3.2 Problem \#1: Restricted Operations

å¦‚æœä¸€ä¸ªè¿›ç¨‹æƒ³è¦åšæ¯”å¦‚

- å¤„ç†ç£ç›˜çš„IOè¯·æ±‚ï¼›
- è·å–æ›´å¤šç³»ç»Ÿèµ„æºï¼ˆæ¯”å¦‚CPUï¼‰

è¿™æ ·éœ€è¦é™åˆ¶çš„è¡Œä¸ºï¼Œä½œä¸ºOSæ¥è¯´åº”è¯¥æ€ä¹ˆåŠï¼Ÿ

æœ€ç®€å•çš„åŠæ³•ï¼š**æ‚¨éšä¾¿æŠ˜è…¾**ã€‚ä¹Ÿå°±æ˜¯å…è®¸è¿›ç¨‹åšä»»ä½•æƒ³åšçš„äº‹æƒ…ã€‚ä½†æ˜¯è¿™æ ·è‚¯å®šæ˜¯ä¸å®‰å…¨çš„ã€‚æ¯”å¦‚è¿›ç¨‹æƒ³è¦è®¿é—®**ä¸€ä¸ªæ–‡ä»¶**çš„æ—¶å€™ï¼ŒOSè¦æ£€æŸ¥æƒé™ã€‚ä½†æ˜¯è¿™ä¸ªæ—¶å€™å¦‚æœOSç›´æ¥è¯´ï¼šå•Šï¼Œä½ è¦è®¿é—®æ–‡ä»¶å•Šï¼Œé‚£æ–‡ä»¶ç³»ç»Ÿä½ éšä¾¿ç”¨å§ï¼ç®€å•æ˜¯ç®€å•ï¼Œä¹Ÿèƒ½å®ç°åŠŸèƒ½ï¼Œä½†æ˜¯ä¹Ÿå¤ªä¸å®‰å…¨äº†ã€‚è¿›ç¨‹åªæƒ³è®¿é—®ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯ä½ æŠŠæ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„è¯»å†™éƒ½äº¤ç»™å®ƒäº†ã€‚

OSè§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•æ˜¯ï¼Œå¼•å…¥**ç”¨æˆ·æ€**ï¼ˆuser modeï¼‰å’Œ**å†…æ ¸æ€**ï¼ˆkernel modeï¼‰ã€‚åœ¨ç”¨æˆ·æ€ï¼Œè¿›ç¨‹æ ¹æœ¬å°±ä¸å…è®¸å‘é€IOè¯·æ±‚ã€‚ä½ è¦æ˜¯å‘é€äº†ï¼Œåæœå°±æ˜¯è¿›ç¨‹ç›´æ¥å¼‚å¸¸ï¼Œè¢«OSå¹²æ‰ï¼›è€Œåœ¨å†…æ ¸æ€ï¼Œè¿™äº›ä»£ç å°±éšä¾¿äº†ï¼Œæ¯”å¦‚IOè¯·æ±‚ï¼Œå…¶å®ƒçš„æœ‰é™åˆ¶çš„ä»£ç éƒ½èƒ½è¿è¡Œã€‚

é‚£è¿™æ ·çš„é—®é¢˜æ˜¾è€Œæ˜“è§ï¼šæˆ‘è¿›ç¨‹è¿˜ä¸è®©è¯»æ–‡ä»¶äº†ï¼Ÿå‡­å•¥ï¼Ÿå› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»è®©ç”¨æˆ·æ€çš„ç¨‹åºä¹Ÿèƒ½æ‰§è¡Œä¸€äº›æœ‰é™åˆ¶çš„æŒ‡ä»¤ã€‚è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹å¼å°±æ˜¯**ç³»ç»Ÿè°ƒç”¨**ï¼ˆsystem callï¼‰ã€‚**ç³»ç»Ÿè°ƒç”¨æ˜¯å†…æ ¸å¾ˆå°å¿ƒåœ°æš´éœ²å‡ºæ¥çš„ä¸€å°éƒ¨åˆ†åŠŸèƒ½**ï¼Œç»™ç”¨æˆ·æ€çš„è¿›ç¨‹å»ç”¨ã€‚æ¯”å¦‚è®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼Œå’Œå…¶å®ƒè¿›ç¨‹é€šä¿¡ï¼Œåˆ†é…æ›´å¤šå†…å­˜ç­‰ç­‰ã€‚

> [!note]
> æˆ‘ä»¬[[Study Log/os_study/2_virtualization/2_2_process_api|ä¸Šä¸€èŠ‚]]ä»‹ç»çš„ä¸œè¥¿å°±éƒ½æ˜¯ç³»ç»Ÿè°ƒç”¨ã€‚è¿™é‡Œå†è¯´ä¸€ä¸‹æˆ‘å¯¹ç³»ç»Ÿè°ƒç”¨çš„ç†è§£ã€‚
> 
> æˆ‘ä»¬ç›´æ¥è¯´æ±‡ç¼–ï¼Œå› ä¸ºå’ŒçœŸæ­£çš„æœºå™¨æŒ‡ä»¤æ˜¯æœ€åƒçš„ã€‚å‡è®¾æ ¹æœ¬æ²¡æœ‰æ“ä½œç³»ç»Ÿï¼Œæˆ‘ä»¬ç¼–å†™çš„ç¨‹åºåº”è¯¥æ˜¯æ€æ ·çš„ï¼Ÿæ˜¾ç„¶ï¼Œå°±æ˜¯ä¸€äº›è®¡ç®—ï¼Œå¯¹å†…å­˜çš„è¯»å–ï¼Œå¯¹å¯„å­˜å™¨çš„è¯»å–ï¼Œå¯¹IOè®¾å¤‡çš„è®¿é—®ç­‰ç­‰ã€‚é‚£ä¹ˆè¿™äº›æŒ‡ä»¤æ˜¯å¯ä»¥éšä¾¿æ‰§è¡Œçš„å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯ã€‚æ¯”å¦‚å†…å­˜ï¼Œå¦‚æœç›´æ¥è°ƒç”¨LEAæŒ‡ä»¤å°±èƒ½åŠ è½½å†…å­˜ä¸­ä»»æ„åœ°å€çš„æ•°æ®ï¼Œé‚£ä¸æ˜¯æ•´ä¸ªç³»ç»Ÿï¼ˆè™½ç„¶æ²¡æœ‰ç³»ç»Ÿï¼Œä½†æ˜¯å°±è¿™ä¹ˆè¯´äº†ï¼‰é‡Œæ‰€æœ‰çš„æ•°æ®æˆ‘éƒ½æœ‰äº†ï¼Ÿå³ä½¿ä¸æ˜¯æˆ‘è¿™ä¸ªè¿›ç¨‹çš„ã€‚é‚£æ“ä½œç³»ç»Ÿé‡Œå¼•å…¥ç³»ç»Ÿè°ƒç”¨æœ€æ ¹æœ¬çš„ç›®çš„ï¼Œå°±æ˜¯å°†è¿™äº›ä¸èƒ½ç»™äººéšä¾¿æ‰§è¡Œçš„æŒ‡ä»¤å°è£…èµ·æ¥ï¼Œå¹¶ä¸”ä¸èƒ½è®©ç”¨æˆ·æ€çš„è¿›ç¨‹éšä¾¿ä½¿ç”¨ï¼Œå¿…é¡»æ˜¯åŠ ä»¥ä¸¥æ ¼é™åˆ¶ï¼ŒæŒ‰ç…§è§„èŒƒæ¥ä½¿ç”¨ã€‚

ä¸ºäº†æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œç¨‹åºå¿…é¡»æ‰§è¡Œä¸€ä¸ª**trap**æŒ‡ä»¤ã€‚è¯¥æŒ‡ä»¤èƒ½è®©ç¨‹åºä»ç”¨æˆ·æ€é™·å…¥åˆ°å†…æ ¸æ€ï¼Œä»è€Œæ‰§è¡Œå†…æ ¸æ€çš„ä»£ç ã€‚æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œä¸€ä¸ª**return-from-trap**æŒ‡ä»¤å›åˆ°ç”¨æˆ·æ€ã€‚

> [!attention]
> æœ¬äººè®¤ä¸ºï¼Œä»¥ä¸‹æ‰€è¯´çš„ã€ç¡¬ä»¶ã€‘å¯ä»¥è®¤ä¸ºå°±æ˜¯CPUã€‚å½“ç„¶å¯èƒ½ä¹ŸåŒ…æ‹¬ä¸€äº›CPUå’Œå†…å­˜ï¼ŒIOè®¾å¤‡ç­‰é…åˆå®Œæˆçš„å·¥ä½œã€‚

ç¡¬ä»¶åœ¨trapæ‰§è¡Œçš„æ—¶å€™éœ€è¦åšä¸€äº›å®‰å…¨ä¿éšœå·¥ä½œï¼Œä»¥ä¾¿ä»å†…æ ¸æ€è¿”å›æ—¶ï¼Œç¨‹åºçš„ä¸€äº›å¯„å­˜å™¨ç­‰èƒ½æ­£å¸¸å·¥ä½œã€‚æ¯”å¦‚åœ¨x86ä¸Šï¼Œå¤„ç†å™¨ä¼šæŠŠPCæŒ‡é’ˆï¼Œä¸€äº›æ ‡è®°ä½ï¼Œè¿˜æœ‰å…¶å®ƒçš„ä¸€äº›å¯„å­˜å™¨ä¿å­˜åˆ°ä¸€ä¸ª**å†…æ ¸æ ˆ**ï¼ˆkernel stackï¼‰é‡Œã€‚è¿™ç©æ„å„¿æ˜¯æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªçš„ã€‚  ^8ee3ee

è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼štrapæ˜¯æ€ä¹ˆçŸ¥é“è¿è¡Œå“ªæ®µä»£ç çš„ï¼Ÿæ˜¾ç„¶ï¼Œè¿™ä¸ªä»£ç çš„åœ°å€è‚¯å®šä¸æ˜¯è®©ç”¨æˆ·æ€çš„è¿›ç¨‹å»æŒ‡å®šçš„ã€‚æ¯”å¦‚æ‰“å¼€æ–‡ä»¶çš„è¿™ä¸ªopenï¼Œå®é™…ä¸Šæˆ‘ä»¬ä¸æ˜¯é€šè¿‡è°ƒç”¨`syscall(0x123456)`ä¹‹ç±»çš„æ–¹å¼ã€‚å¦‚æœ`0x123456`é‡Œçš„ä»£ç çœŸå°±æ˜¯openåœ¨å†…æ ¸ä¸­å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨çš„ä»£ç çš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘å®Œå…¨å¯ä»¥ä¼ å…¥ä¸€ä¸ªéšä¾¿çš„åœ°å€ï¼Œç”šè‡³å¯ä»¥é€šè¿‡å¾ˆå¤š**é‚ªæ¶**çš„æ‰‹æ®µæ‰§è¡Œä»»æ„ä»£ç ï¼ˆæ¯”å¦‚å¯ä»¥é€šè¿‡ä¸€ä¸ªåç§»é‡ç›´æ¥å®šä½åˆ°ä¸€è¡Œä»£ç ï¼Œç„¶åå†è¿™æ ·ï¼Œä¸€ç‚¹ç‚¹æ‹¼æˆè‡ªå·±æƒ³æ‰§è¡Œçš„æ¶æ„ç¨‹åºï¼‰ã€‚

OSè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹å¼æ˜¯é€šè¿‡**trap table**ã€‚å½“å¼€æœºçš„æ—¶å€™ï¼ŒOSé¦–å…ˆè¦åšçš„äº‹æƒ…å°±æ˜¯ï¼š**å½“ç‰¹å®šçš„äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œç¡¬ä»¶åº”è¯¥åšä»€ä¹ˆ**ã€‚æ¯”å¦‚ç¡¬ç›˜çš„ä¸­æ–­äº§ç”Ÿçš„æ—¶å€™åšä»€ä¹ˆï¼Œé”®ç›˜ä¸­æ–­çš„æ—¶å€™åšä»€ä¹ˆï¼Œä¸€ä¸ªè¿›ç¨‹å‘é€ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™åšä»€ä¹ˆç­‰ã€‚è¿™é‡Œçš„â€œåšä»€ä¹ˆâ€å…·ä½“æ¥è®²ï¼Œå°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå«åš**trap handler**ã€‚ä¹Ÿå°±æ˜¯é™·å…¥å†…æ ¸çš„å¤„ç†è€…ã€‚==OSè®¾ç½®å¥½trap table==ï¼Œå¹¶å‘ŠçŸ¥ç»™ç¡¬ä»¶ä»¬ï¼Œè¿™æ ·ç›´åˆ°ä¸‹ä¸€æ¬¡å¯åŠ¨ä¹‹å‰ï¼Œç¡¬ä»¶éƒ½çŸ¥é“åº”è¯¥åšä»€ä¹ˆäº†ã€‚ ^bf8972

> [!comment] OSè®¾ç½®å¥½trap table
> ä»è¿™é‡Œä¹Ÿèƒ½çœ‹å‡ºï¼Œåœ°å€æ˜¯éšæœºçš„ï¼Œè¿™æ ·æ”»å‡»çš„ç¨‹åºå°±ä¸èƒ½éšä¾¿æŒ‡å®šåœ°å€äº†ã€‚å¦å¤–é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œtrap handlerå…¶å®å°±æ˜¯ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°ã€‚åªä¸è¿‡åœ¨å‰é¢ä¼šå…ˆè¿›è¡Œä¸€ä¸ª==éªŒè¯==ã€‚

é‚£æ—¢ç„¶åœ°å€æ˜¯éšæœºçš„ï¼Ÿå¯¹äºç”¨æˆ·ç¨‹åºæ¥è¯´ï¼Œæˆ‘æ€ä¹ˆçŸ¥é“å‘é€å“ªä¸ªç³»ç»Ÿè°ƒç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡**ç³»ç»Ÿè°ƒç”¨å·**ï¼ˆsystem-call numberï¼‰ã€‚å½“trapè¿›å†…æ ¸æ€ï¼Œè¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼Œ==å…ˆçœ‹è¿™ä¸ªå·æ˜¯å¦æœ‰æ•ˆ==ï¼Œç„¶åå»æ‰§è¡Œå¯¹åº”çš„ä»£ç ã€‚è¿™æ ·å°±èµ·åˆ°äº†ä¿æŠ¤ä½œç”¨ï¼Œç”¨æˆ·æ€ç¨‹åºåªèƒ½é€šè¿‡è°ƒç”¨å·æ¥æ‰§è¡Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ˜¯ä¸èƒ½è·³åˆ°ç‰¹å®šçš„åœ°å€ä¸Šã€‚ ğŸ¤¨ åœ°å€ä¹Ÿæ ¹æœ¬ä¸ä¼šæš´éœ²å‡ºå»ï¼ˆæˆ‘çè¯´çš„ï¼Œå­˜ç–‘ï¼‰ã€‚

> [!question] ä¸ºä»€ä¹ˆç³»ç»Ÿè°ƒç”¨çœ‹èµ·æ¥é‚£ä¹ˆåƒæ™®é€šå‡½æ•°è°ƒç”¨ï¼Ÿ
> æ¯”å¦‚`open()`å’Œ`read()`ï¼Œå°±å’Œæˆ‘ä»¬åœ¨Cé‡Œè‡ªå·±å†™çš„å‡½æ•°æ²¡å•¥åŒºåˆ«ã€‚é‚£æ—¢ç„¶è¿™æ ·çš„è¯ï¼Œå‡­å•¥OSè®¤ä¸ºè¿™ä¸œè¥¿å°±æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬è‡ªå·±å†™çš„å‡½æ•°å°±ä¸æ˜¯ç³»ç»Ÿè°ƒç”¨å‘¢ï¼Ÿå®é™…ä¸Šï¼Œç³»ç»Ÿè°ƒç”¨çš„è¿™äº›å‡½æ•°æœ¬èº«æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œç‰¹æ®Šçš„æ˜¯åœ¨å‡½æ•°é‡Œéšè—çš„trapæŒ‡ä»¤ã€‚è¯¦ç»†ç‚¹å„¿è¯´ï¼Œå½“æˆ‘ä»¬è°ƒç”¨opençš„æ—¶å€™ï¼Œå°±æ˜¯è°ƒç”¨åˆ°Cæ ‡å‡†åº“ï¼Œå’Œå…¶ä»–çš„å‡½æ•°æ²¡å•¥åŒºåˆ«ã€‚ä½†æ˜¯ç‰¹æ®Šåœ¨åº“é‡Œé¢ï¼Œä¼šæŠŠopençš„å‚æ•°æ”¾åˆ°ä¸€ä¸ªç‰¹å®šçš„ä½ç½®ï¼ˆæ¯”å¦‚åœ¨æ ˆä¸Šæˆ–è€…ç‰¹æ®Šçš„å¯„å­˜å™¨é‡Œï¼‰ï¼Œä¹Ÿä¼šæŠŠç³»ç»Ÿè°ƒç”¨çš„è°ƒç”¨å·æ”¾åˆ°é‚£é‡Œï¼Œç„¶åå¼€å§‹æ‰§è¡ŒtrapæŒ‡ä»¤ã€‚æ‰§è¡Œå®Œtrapä¹‹åï¼Œå°±æ˜¯å¤„ç†è¿”å›å€¼ï¼Œç„¶åæŠŠæ§åˆ¶æƒäº¤å›ç»™ç”¨æˆ·æ€çš„ç¨‹åºã€‚å› æ­¤ï¼Œè¿™ä¸€æ®µä»£ç æ˜¯ç”¨æ±‡ç¼–ç¡¬ç¼–ç åœ¨Cæ ‡å‡†åº“é‡Œçš„ã€‚

æœ€åï¼ŒOSè®¾ç½®trap tableçš„è¿™ä¸ªè¡Œä¸ºï¼Œä¹Ÿå°±æ˜¯å‘Šè¯‰ç¡¬ä»¶trap tableåœ¨å“ªé‡Œè¿™ä¸ªæŒ‡ä»¤æœ¬èº«è‚¯å®šä¹Ÿæ˜¯ä¸€ä¸ªæœ‰æƒé™çš„æŒ‡ä»¤ï¼Œåªèƒ½ç”±å†…æ ¸æ¥åšã€‚

> [!tip] è­¦æƒ•ç”¨æˆ·çš„è¾“å…¥ï¼
> æˆ‘ä»¬ç°åœ¨åšçš„å…³äºå®‰å…¨çš„ä¸œè¥¿ï¼š
> 
> - åŠ äº†ä¸€ä¸ªtrapæœºåˆ¶ï¼Œè®©ç¡¬ä»¶æ¥é™·å…¥å†…æ ¸ï¼›
> - ç¡®ä¿æ‰€æœ‰çš„å…³äºOSçš„æ ¸å¿ƒä»£ç çš„æ‰§è¡Œéƒ½è¦é€šè¿‡trapæœºåˆ¶ã€‚
> 
> ä½†æ˜¯ï¼Œè·ç¦»çœŸæ­£çš„å®‰å…¨ç³»ç»Ÿè¿˜æ˜¯å·®å¾—è¿œã€‚æ¯”å¦‚ï¼Œç³»ç»Ÿè°ƒç”¨é‡Œä¼ å…¥çš„è¿™ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å°±å¾—å¥½å¥½æ£€æŸ¥ä¸€ä¸‹ã€‚
> 
> æ¯”å¦‚ï¼Œwriteç³»ç»Ÿè°ƒç”¨å¯ä»¥å¾€åœ°å€é‡Œå†™ä¸œè¥¿ã€‚é‚£å¦‚æœæˆ‘ä¼ å…¥äº†ä¸€æ®µå†…æ ¸ç©ºé—´çš„åœ°å€ï¼Œç„¶åä½ è¿˜è®©æˆ‘å†™ï¼Œé‚£å¯æ¯äº†ã€‚è¿™æ®µåœ°å€æœ‰å¯èƒ½åŒ…æ‹¬çœŸæ­£çš„ç‰©ç†å†…å­˜ã€‚è¿™ç”šè‡³ä¼šè®©è¿™ä¸ªç¨‹åºèƒ½è¯»ç³»ç»Ÿä¸Šè¿è¡Œçš„æ‰€æœ‰ç¨‹åºçš„å†…å­˜ã€‚

æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹trapæœºåˆ¶å»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨çš„æ—¶é—´çº¿ï¼ˆä¸‹é¢çš„æ€»ç»“é‡Œå‡è®¾æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸ª[[#^8ee3ee|å†…æ ¸æ ˆç©ºé—´]]ï¼Œç”¨äºä¿å­˜å¯„å­˜å™¨å’ŒPCæŒ‡é’ˆï¼‰ï¼š

![[Study Log/os_study/2_virtualization/resources/Drawing 2024-07-02 16.55.14.excalidraw.svg]]

ååˆ†å»ºè®®å’Œ[[#^90c713|ä¹‹å‰çš„è¡¨æ ¼]]å¯¹æ¯”ç€è¯»ã€‚LDEçš„æ‰§è¡Œåˆ†æˆä¸¤ä¸ªé˜¶æ®µã€‚ç¬¬ä¸€ä¸ªæ˜¯å¯åŠ¨ï¼ˆbootï¼‰é˜¶æ®µï¼Œå†…æ ¸ä¼šåˆå§‹åŒ–trap tableï¼ŒCPUä¼šè®°ä½å®ƒçš„åœ°å€ï¼ˆå½“ç„¶ä¹ŸåŒ…æ‹¬trap handlerï¼‰ä¸ºäº†æ¥ä¸‹æ¥å¤„ç†ç³»ç»Ÿè°ƒç”¨ã€‚åˆå§‹åŒ–å·¥ä½œä¹Ÿæ˜¯ä¸€ä¸ªæœ‰æƒé™æ‰èƒ½æ‰§è¡Œçš„æŒ‡ä»¤ï¼ˆä¸Šå›¾æ ‡çº¢çš„éƒ½æ˜¯æœ‰æƒé™æ‰èƒ½æ‰§è¡Œçš„ï¼‰ã€‚åœ¨ç¨‹åºå¯åŠ¨å‰ï¼Œä¹Ÿä¼šè°ƒç”¨ä¸€ä¸ªreturn-from-trapæŒ‡ä»¤æ¥åˆ‡æ¢åˆ°ç”¨æˆ·æ€ã€‚è¿™ä¸ªæ˜¯ä¹‹å‰çš„è¡¨æ ¼ä¸­æ²¡æœ‰æåˆ°çš„äº‹æƒ…ã€‚å½“ç¨‹åºè¿è¡Œç»“æŸä¹‹åï¼Œè°ƒç”¨exitç³»ç»Ÿè°ƒç”¨æ¥é€€å‡ºç¨‹åºã€‚è¿™ä¹Ÿä¼šå¯¼è‡´é™·å…¥å†…æ ¸æ€ï¼Œå› ä¸ºè¦å¤„ç†å†…å­˜é‡Šæ”¾ã€åˆ é™¤process list entryç­‰æ“ä½œã€‚

### 2.3.3 Problem \#2: Switching Between Processes

æˆ‘ä»¬ç°åœ¨çš„ç­–ç•¥æ˜¯time-sharingï¼Œä¹Ÿå°±æ˜¯CPUä¼šè¿è¡Œä¸€ä¼šå„¿è¿™ä¸ªç¨‹åºï¼Œå†è¿è¡Œä¸€ä¼šå„¿é‚£ä¸ªã€‚é‚£è¿™é‡ŒèƒŒåå…¶å®éšè—ç€ä¸€ä¸ªæ¯”è¾ƒè‡´å‘½çš„bugï¼š**OSæœ¬èº«ä¹Ÿæ˜¯ç¨‹åº**ã€‚é‚£å¦‚æœæˆ‘åˆ‡æ¢åˆ°äº†éšä¾¿ä¸€ä¸ªè¿›ç¨‹å»è¿è¡Œï¼Œ**è¿™ä¸ªæ—¶å€™OSå°±ä¸åœ¨è¿è¡Œäº†**ã€‚é‚£æ—¢ç„¶OSéƒ½æ²¡è¿è¡Œï¼Œå®ƒåˆæ€ä¹ˆèƒ½åˆ‡æ¢è¿›ç¨‹ï¼Ÿ

#### 2.3.3.1 A Cooperative Approach: Wait For System Calls

è¿™ç§æ–¹å¼åœ¨è€å¼çš„OSï¼ˆMacintoshçš„è€ç‰ˆæœ¬ï¼Œæˆ–è€…è€çš„Xerox Altoç³»ç»Ÿï¼‰ä¸Šæœ‰ï¼Œå› ä¸ºå¬ç€å°±æŒºç„ä¹ï¼šç­‰ç€è¿›ç¨‹å‘é€ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ ·æˆ‘å°±èƒ½é‡æ–°è·å¾—æ§åˆ¶æƒã€‚æ˜¾ç„¶ï¼Œè¿™ç§ç­–ç•¥æ˜¯å¾ˆpassiveçš„ã€‚

è¿™ç§ç­–ç•¥å»ºç«‹åœ¨OSå¯¹è¿›ç¨‹çš„ä¿¡ä»»ä¸Šï¼šè¿›ç¨‹å¦‚æœåœ¨CPUä¸Šè¿è¡Œäº†å¤ªé•¿æ—¶é—´ï¼Œè‡ªå·±å°±ä¼šä¸»åŠ¨æ”¾å¼ƒCPUçš„ä½¿ç”¨æƒä»è€Œäº¤ç»™å…¶ä»–äººã€‚æ”¾å¼ƒçš„æ–¹å¼å°±æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ã€‚æ™®é€šçš„ç³»ç»Ÿè°ƒç”¨æ¯”å¦‚openï¼Œwriteç­‰å½“ç„¶ä¹Ÿå¯ä»¥åšè¿™ä»¶äº‹ï¼Œä½†æ˜¯æ˜¾å¾—æ¯”è¾ƒéšä¾¿ã€‚æ‰€ä»¥è¿™æ ·çš„OSé€šå¸¸éƒ½ä¼šç»™ä½ ä¸€ä¸ªé¢å¤–çš„ç³»ç»Ÿè°ƒç”¨**yield**æ¥åšè¿™ä»¶äº‹ã€‚yieldä¸ä¼šåšä»»ä½•å…¶ä»–çš„äº‹æƒ…ï¼Œåªæ˜¯ç”¨äºå°†æ§åˆ¶æƒäº¤è¿˜ç»™CPUè€Œå·²ã€‚

- [ ] #TODO tasktodo1719926008742 javaçº¿ç¨‹ä¹Ÿæœ‰yieldï¼ŒåŠŸèƒ½ç±»ä¼¼ï¼Œä½†æ˜¯å¥½åƒä¸å¸¸ç”¨ï¼›POSIX Threadæ˜¯ä¸æ˜¯ä¹Ÿåº”è¯¥æœ‰è¿™ä¸ªä¸œè¥¿ï¼Ÿä¹‹åæœ‰æ—¶é—´çœ‹ä¸€çœ‹ã€‚ â• 2024-07-02 ğŸ”½ ğŸ†” 8shvfk

å½“ç¨‹åºè¿›è¡Œä¸€äº›éæ³•è¡Œä¸ºçš„æ—¶å€™ï¼Œä¹Ÿä¼šæŠŠæ§åˆ¶æƒäº¤ç»™OSã€‚æ¯”å¦‚ï¼Œæ¥ä¸ª0åšé™¤æ•°çš„è®¡ç®—ï¼Œæˆ–è€…è®¿é—®ä¸€äº›éæ³•å†…å­˜çš„æ—¶å€™ï¼Œä¹Ÿä¼šæ‰§è¡Œä¸€ä¸ªtrapæŒ‡ä»¤ã€‚è¿™ä¸ªæ—¶å€™OSä¼šé‡æ–°è·å¾—æ§åˆ¶æƒï¼Œç„¶åå¾ˆå¯èƒ½å°±æŠŠè¿™ä¸ªè¿›ç¨‹ç»™å¹²æ‰äº†ã€‚

æ€»ç»“ï¼Œè¢«åŠ¨ï¼Œå¾ˆä¸é è°±ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹ä¸€ç›´ä¸å‘é€ç³»ç»Ÿè°ƒç”¨ï¼Œæ¯”å¦‚ç›´æ¥æ­»å¾ªç¯äº†ï¼Œé‚£å’‹åŠï¼Ÿ

#### 2.3.3.2 A Non-Cooperative Approach: The OS Takes Control

å¦‚æœä¸€ä¸ªè¿›ç¨‹å°±æ˜¯ä¸å‘é€ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£æˆ‘åº”è¯¥æ€ä¹ˆåŠï¼Ÿè§£å†³æ–¹æ³•å¾ˆä¹…ä¹‹å‰å°±æœ‰å¾ˆå¤šäººå‘ç°äº†ï¼š**æ—¢ç„¶ä½ è¿›ç¨‹ä¸é…åˆï¼Œæˆ‘å°±æ‰¾ä¸ªä¸“é—¨çš„äººæ¥é…åˆ**ã€‚åœ¨è¿™äº›ç³»ç»Ÿä¸­æœ‰ä¸ªä¸“é—¨çš„timerè®¾å¤‡ï¼Œä¼šä»¥å›ºå®šçš„é¢‘ç‡å‘é€timer interruptã€‚å½“è¿™ç§ä¸­æ–­äº§ç”Ÿæ—¶ï¼Œè¿›ç¨‹å°±ä¼šæš‚åœè¿è¡Œï¼Œç„¶åOSå†…éƒ¨é¢„å…ˆå‡†å¤‡å¥½çš„interrupt handlerå°±ä¼šè¿è¡Œã€‚è¿™ä¸ªæ—¶å€™OSå°±é‡æ–°è·å¾—æ§åˆ¶æƒï¼Œå°±å¯ä»¥åˆ‡æ¢è¿›ç¨‹äº†ã€‚

å°±åƒæˆ‘ä»¬[[#^bf8972|ä¹‹å‰]]è®¨è®ºçš„ï¼ŒOSå¿…é¡»å‘Šè¯‰ç¡¬ä»¶å½“æŸäº›ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶åº”è¯¥åšä»€ä¹ˆã€‚timerå°±æ˜¯å…¶ä¸­ä¸€ä¸ªã€‚å½“timer interruptäº§ç”Ÿæ—¶ï¼ŒOSä¹Ÿéœ€è¦å¤„ç†å¯¹åº”çš„äº‹ä»¶ã€‚æ‰€ä»¥å®ƒä¹Ÿè¦å‘Šè¯‰CPUï¼›å¦å¤–ï¼Œå¼€æœºçš„æ—¶å€™ï¼ŒOSä¹Ÿå¿…é¡»è¦å¯åŠ¨timerï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæœ‰æƒé™çš„æŒ‡ä»¤ã€‚ç„¶åï¼Œä¸ç®¡æ€ä¹ˆæ ·ï¼ŒOSæœ€ç»ˆéƒ½ä¼šå¾—åˆ°æ§åˆ¶æƒäº†ã€‚å¦å¤–ï¼Œtimerä¹Ÿå¯ä»¥å…³é—­ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹åå­¦å¹¶å‘çš„æ—¶å€™ä¼šæåˆ°ã€‚

- [ ] #TODO tasktodo1719929090619 â†‘ timerå¯ä»¥å…³é—­æåˆ°äº†å—ï¼Ÿ â• 2024-07-02 ğŸ”½ ğŸ†” ok57rm

æ³¨æ„ï¼Œtimer interruptçš„å¤„ç†æ–¹å¼å’Œtrapå¾ˆåƒï¼Œéƒ½æ˜¯éœ€è¦ç¡¬ä»¶å»ä¿å­˜ç‰¹å®šçš„å¯„å­˜å™¨ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜ç°åœºï¼Œä¹‹åreturn-from-trapçš„æ—¶å€™ä¹‹å‰æŒ‚èµ·çš„ç¨‹åºæ‰èƒ½æ¢å¤è¿è¡Œã€‚

> [!note]
> è¿™é‡Œè¯´ä¸€ä¸‹æˆ‘å¯¹trapè¿™ç§æ¨¡å¼çš„ç†è§£ï¼Œä¸ºä»€ä¹ˆç¡¬ä»¶éœ€è¦å‚ä¸ã€‚å®é™…ä¸Šï¼Œæ‰€æœ‰çš„ç¨‹åºéƒ½éœ€è¦è¿è¡Œåœ¨CPUä¸Šï¼ŒOSä¹Ÿä¸ä¾‹å¤–ï¼Œå®ƒä¹Ÿæ˜¯ä¸€å †ç¨‹åºç»„æˆçš„ï¼Œä¹Ÿéœ€è¦è¿è¡Œåœ¨CPUä¸Šã€‚æ‹¿[[Study Log/os_study/2_virtualization/resources/Drawing 2024-07-02 16.55.14.excalidraw.svg|ä¹‹å‰çš„è¡¨æ ¼]]æ¥ä¸¾ä¾‹å­ï¼Œä»å·¦åˆ°å³å°±æ˜¯ä¸€ä¸ªã€è½¯-ç¡¬-è½¯ã€çš„ç»“æ„ã€‚ä½†æ˜¯å®é™…ä¸Š**ä¸¤ä¸ªè½¯**çš„å†…å®¹æœ€ç»ˆä¹Ÿéƒ½è¦è¿è¡Œåœ¨**è¿™ä¸ªç¡¬**ä¸Šã€‚è€Œç¡¬é‡Œé¢è¿è¡Œçš„å†…å®¹ï¼Œæ¯”å¦‚ä¿å­˜å¯„å­˜å™¨åˆ°å†…æ ¸æ ˆç­‰ç­‰ï¼Œè¿™äº›æŒ‡ä»¤æœ¬èº«ä¹Ÿæ˜¯è¿è¡Œåœ¨ç¡¬ä¸Šçš„ã€‚ä¹‹æ‰€ä»¥è¦åˆ†æˆä¸‰åˆ—ï¼Œä¸»è¦æ˜¯å–å†³äºâ€œè°å¯¹è¿™æ®µä»£ç **è´Ÿè´£**â€ï¼Œè€Œä¸æ˜¯â€œè°**è¿è¡Œ**è¿™æ®µä»£ç â€ã€‚ç¨‹åºå‘˜å†™çš„ç”¨æˆ·æ€è¿›ç¨‹ä¹Ÿè¿è¡Œåœ¨CPUä¸Šï¼Œä½†æ˜¯ç¨‹åºå‘˜ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ€è¦å¯¹å®ƒè¿›è¡Œè´Ÿè´£ï¼Œæ‰€ä»¥æ‰å†™åˆ°ç¬¬ä¸‰åˆ—ã€‚
> 
> è€ŒOSåœ¨è¿™é‡Œçš„ç‰¹æ®Šæ€§ï¼Œæˆ–è€…è¯´å†…æ ¸æ€çš„ç‰¹æ®Šæ€§ï¼Œæ˜¯åœ¨è½¯ä»¶å±‚é¢ä¸Šè§„å®šè°æ¥è¿è¡Œç¨‹åºï¼Œä¹Ÿå°±æ˜¯è°ä½¿ç”¨CPUã€‚å› æ­¤ï¼ŒOSå½“ç„¶æœ‰æƒåˆ©ç›´æ¥åœ¨CPUä¸Šè¿è¡ŒæŒ‡ä»¤ï¼Œå…¶å®ä»»ä½•ä¸€ä¸ªè¿›ç¨‹éƒ½å¯ä»¥ï¼Œåªä¸è¿‡OSåœ¨å†…æ ¸æ€ï¼Œæ‰€ä»¥èƒ½è¿è¡Œä¸€äº›æœ‰ç‰¹æƒçš„æŒ‡ä»¤æ¥ä¿è¯ç³»ç»Ÿæ­£å¸¸å·¥ä½œã€‚

#### 2.3.3.3 Saving and Restoring Context

OSé‡æ–°è·å¾—æ§åˆ¶æƒä¹‹åï¼Œéœ€è¦åšå†³å®šäº†ï¼šæ˜¯ç»§ç»­è¿è¡Œå½“å‰ç¨‹åºï¼Œè¿˜æ˜¯è¿è¡Œå…¶å®ƒçš„ã€‚åšè¿™ä»¶äº‹çš„æ˜¯OSå†…éƒ¨çš„è°ƒåº¦å™¨ï¼ˆschedulerï¼‰ï¼Œä¹‹åæˆ‘ä»¬ä¼šè¯¦ç»†è®¨è®ºã€‚

å¦‚æœç¡®å®šè¦åˆ‡æ¢è¿›ç¨‹çš„è¯ï¼ŒOSå°±ä¼šæ‰§è¡Œä¸€ç³»åˆ—ä»£ç ï¼Œå«åš**ä¸Šä¸‹æ–‡åˆ‡æ¢**ï¼ˆcontext switchï¼‰ã€‚å…·ä½“å·¥ä½œä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ä¿å­˜å½“å‰è¿›ç¨‹çš„å¯„å­˜å™¨ï¼Œå°è¯•æ¢å¤å³å°†è¿è¡Œçš„è¿›ç¨‹çš„å¯„å­˜å™¨ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š

![[Study Log/os_study/2_virtualization/resources/Drawing 2024-07-02 22.59.22.excalidraw.svg]]

æ³¨æ„ç‚¹ï¼š

- å½“timer interruptäº§ç”Ÿæ—¶ï¼Œéœ€è¦åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œè®©OSé‡æ–°å¤ºå›CPUä½¿ç”¨æƒï¼›
- åœ¨åˆ‡æ¢åˆ°å†…æ ¸æ€ä¹‹å‰ï¼Œè¦ä¿å­˜å½“å‰è¿›ç¨‹ï¼ˆAï¼‰çš„å¯„å­˜å™¨ï¼Œåˆ°Açš„**å†…æ ¸æ ˆ**ï¼›
- å½“OSè·å¾—äº†æ§åˆ¶æƒä¹‹åï¼Œå®ƒ**å†³å®š**ï¼ˆé€šè¿‡schedulorï¼‰ä»Aåˆ‡æ¢åˆ°Bï¼›
- OSè°ƒç”¨`switch()`æ¥åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼›
- `switch()`æ‰€åšçš„äº‹æƒ…ï¼š
	- ä¿å­˜Açš„å¯„å­˜å™¨åˆ°Açš„[[Study Log/os_study/2_virtualization/2_1_process#^ad384f|è¿›ç¨‹ç»“æ„]]ï¼›
	- æ¢å¤Bçš„å¯„å­˜å™¨ï¼Œä»Bçš„è¿›ç¨‹ç»“æ„ï¼›
	- è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šé€šè¿‡å°†stack pointeræŒ‡å‘Bçš„å†…æ ¸æ ˆï¼ˆåŸæ¥æ˜¯æŒ‡å‘Açš„ï¼‰ï¼›
- æˆ‘ä»¬å‘ç°ï¼Œç¡¬ä»¶å’ŒOSéƒ½è¿›è¡Œäº†ä¿å­˜/æ¢å¤å¯„å­˜å™¨çš„æ“ä½œã€‚è¿™ä¸¤ä¸ªä¸œè¥¿çš„ç›®çš„æ˜¯ä¸åŒçš„ï¼š
	- CPUä¿å­˜/æ¢å¤çš„æ˜¯**user registers**ï¼Œä¹Ÿå°±æ˜¯ç¨‹åºå‘˜å†™çš„ä»£ç é‡Œç›¸å…³çš„æ•°æ®çš„å¯„å­˜å™¨ã€‚åœ°ç‚¹æ˜¯è¿›ç¨‹çš„å†…æ ¸æ ˆï¼›
	- OSä¿å­˜/æ¢å¤çš„æ˜¯**kernel registers**ï¼Œæ˜¯å’ŒOSç›¸å…³çš„å¯¹äºç»´æŠ¤è¿™ä¸ªè¿›ç¨‹æœ‰ç”¨çš„æ•°æ®çš„å¯„å­˜å™¨ã€‚åœ°ç‚¹æ˜¯è¿›ç¨‹çš„ç»“æ„ï¼›
	- **OSçš„è¿™ä¸ªæ“ä½œèƒ½ä½¿å¾—ç³»ç»Ÿå¥½åƒæ˜¯åˆšç»è¿‡$B \xrightarrow{trap\ into} kernel$ä¸€æ ·ï¼Œå³ä½¿äº‹å®æƒ…å†µæ˜¯$A \xrightarrow{trap\ into} kernel$**ã€‚

- [ ] #TODO tasktodo1731505523333 è¿™é‡Œçš„å†…æ ¸æ ˆæ˜¯ä»€ä¹ˆæ¦‚å¿µï¼Ÿæœ‰æ²¡æœ‰ç›¸å¯¹åº”çš„ç”¨æˆ·æ ˆï¼Ÿæ˜¯ä¸æ˜¯å°±æ˜¯æˆ‘ç†è§£çš„æ¯ä¸ªè¿›ç¨‹çš„æ ˆç©ºé—´ï¼Ÿ â• 2024-11-13 ğŸ”¼ ğŸ†” n9h81t 

xv6å†…æ ¸ä¸­ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ä»£ç ï¼š[.globl swtch swtch: movl 4(%esp), %eax movl 8(%esp), %edx # Save old callee-saved registers pushl %ebp pushl %ebx pushl %esi pushl %edi # Switch stacks movl %esp, (%eax) movl %edx, %esp # Load new callee-saved registers popl %edi popl %esi popl %ebx popl %ebp ret](https://github.com/mit-pdos/xv6-public/blob/master/swtch.S)

```asm
# Context switch
#
#   void swtch(struct context **old, struct context *new);
# 
# Save the current registers on the stack, creating
# a struct context, and save its address in *old.
# Switch stacks to new and pop previously-saved registers.

.globl swtch
swtch:
  movl 4(%esp), %eax
  movl 8(%esp), %edx

  # Save old callee-saved registers
  pushl %ebp
  pushl %ebx
  pushl %esi
  pushl %edi

  # Switch stacks
  movl %esp, (%eax)
  movl %edx, %esp

  # Load new callee-saved registers
  popl %edi
  popl %esi
  popl %ebx
  popl %ebp
  ret
```